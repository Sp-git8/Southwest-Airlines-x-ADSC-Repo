<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;                          
        }

        body {
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            overflow-y: auto;
            font-family: "Ubuntu", sans-serif !important;
        }

        h1 {
            margin-top: 20px;
            font-size: 24px;            
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: capitalize;
            text-align: center;
            font-family: "Ubuntu", sans-serif !important;
        }

        #map {
            width: 90%;
            height: 520px;
            margin: 10px auto; 
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(255, 255, 255, 0.2);
        }

        .button {
            font-family: "Ubuntu", sans-serif !important;
        }

        #dropdown {
            display: none;
        }

        .dropdown-container {
            position: relative;
            display: inline-block;
            margin-top: -22px;
        }

        .dropdown-button {
            background: #1a1a1a;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: "Ubuntu", sans-serif !important;
        }

        .dropdown-button:hover {
            background: #333333;            
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background: #1a1a1a;
            bottom: 100%;
            margin-bottom: 5px;            
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);                    
            z-index: 1000;
            max-height: 220px;
            overflow-y: auto;            
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px 20px;
            color: #ffffff;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s ease;
            border-bottom: 1px solid white;
            font-family: "Ubuntu", sans-serif !important;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #333333;
        }
        
        .dropdown-row {
            margin-top: 10px;
        }

        #key {
            margin: 12px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90%;
        }

        .key-bar {
            width: 100%;
            height: 18px;
            background: linear-gradient(to right, #00e400, #a3e400, #ffff00, #ffcc00, #ff7e00, #ff3f00, #ff0000, #a3005c, #8f3f97);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(255, 255, 255, 0.2);
        }

        .key-labels {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 10px;
        }

        .key-label {
            font-size: 14px;
            color: #ffffff;            
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-family: "Ubuntu", sans-serif !important;
        }

        .custom-popup {
            background: black !important;
            border: 1px solid black !important;
            border-radius: 5px !important;
            color: white !important;
            font-family: "Ubuntu", sans-serif !important;
        }

        .custom-popup .leaflet-popup-content-wrapper {
            background: black !important;
            border-radius: 5px !important;
            font-family: "Ubuntu", sans-serif !important;
        }

        .custom-popup .leaflet-popup-tip {
            background: black !important;
        }

        .dropdown-menu::-webkit-scrollbar {
            width: 8px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: #333333;
            border-radius: 4px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }

        #reset-view {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            cursor: pointer;
        }

        #reset-view:hover {
            background: #333333;
        }

        h2 {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 16px;            
            color: #ffffff;        
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            background: none;
            border: none;
            padding: 0;
            font-family: "Ubuntu", sans-serif !important;
        }

        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out {
            background: black !important;
            color: white !important;
            border: none !important;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 18px;
            cursor: pointer;
            box-sizing: border-box;
            transform: rotate(180deg);
        }

        .leaflet-bar {
            border: none !important;
            box-shadow: none !important;
        }

        .leaflet-control-custom {
            border: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body>
    <h1>Weather Score Project</h1>

    <div id="map"></div>

    <h2 style="text-align: center; margin-bottom: -10px; margin-top: -6px; font-size: 16px;">Weather Score</h2>

    <div id="key">
        <div class="key-bar"></div>
        <div class="key-labels">
            <span class="key-label">0</span>
            <span class="key-label">20</span>
            <span class="key-label">40</span>
            <span class="key-label">60</span>
            <span class="key-label">80</span>
            <span class="key-label">100</span>
        </div>
    </div>

    <div class="dropdown-row">
        <div class="dropdown-container">
            <button class="dropdown-button" id="airport-dropdown-button">Select an airport</button>
            <div class="dropdown-menu" id="airport-dropdown-menu"></div>
        </div>

        <div class="dropdown-container">
            <button class="dropdown-button" id="parameter-dropdown-button">Weather Score Radius Parameter</button>
            <div class="dropdown-menu" id="parameter-dropdown-menu"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script>
        const airports = [
            { name: "Albuquerque International Sunport", code: "ABQ", lat: 35.0402, lon: -106.6090, weather_score: 33.35168798,
                temperature_C_norm: 0.493911793, dew_point_C_norm: 0.07605610404, humidity_percent_norm: 0.2750289288, precipitation_mm_norm: 0.06443317227,
                wind_direction_deg_norm: 0.4488826376, wind_speed_kmh_norm: 0.3660020887, pressure_hPa_norm: 0.6143084465, snow_mm_norm: 0.002812584558 },
            { name: "Ted Stevens Anchorage International Airport", code: "ANC", lat: 61.1743, lon: -149.9985, weather_score: 44.51633851,
                temperature_C_norm: 0.1086822291, dew_point_C_norm: 0.121327352, humidity_percent_norm: 0.8820701153, precipitation_mm_norm: 0.3059664824,
                wind_direction_deg_norm: 0.3365189989, wind_speed_kmh_norm: 0.1743513305, pressure_hPa_norm: 0, snow_mm_norm: 1 },
            { name: "Hartsfield-Jackson Atlanta International Airport", code: "ATL", lat: 33.6407, lon: -84.4277, weather_score: 76.77398578,
                temperature_C_norm: 0.6831314418, dew_point_C_norm: 0.6041162751, humidity_percent_norm: 0.7565555725, precipitation_mm_norm: 0.5727860737,
                wind_direction_deg_norm: 0.7947332324, wind_speed_kmh_norm: 0.451524885, pressure_hPa_norm: 0.9679409693, snow_mm_norm: 0.001321336242 },
            { name: "Boise Airport", code: "BOI", lat: 43.5644, lon: -116.2228, weather_score: 31.50292353,
                temperature_C_norm: 0.3465191907, dew_point_C_norm: 0.1593860251, humidity_percent_norm: 0.5793562335, precipitation_mm_norm: 0.1128221156,
                wind_direction_deg_norm: 0.4261377168, wind_speed_kmh_norm: 0.2123956121, pressure_hPa_norm: 0.7883528536, snow_mm_norm: 0.03413155138 },
            { name: "Logan International Airport", code: "BOS", lat: 42.3656, lon: -71.0096, weather_score: 63.17351475,
                temperature_C_norm: 0.385798596, dew_point_C_norm: 0.3288263136, humidity_percent_norm: 0.7679372573, precipitation_mm_norm: 0.5320218799,
                wind_direction_deg_norm: 0.9868901083, wind_speed_kmh_norm: 0.914784051, pressure_hPa_norm: 0.734429889, snow_mm_norm: 0.06013920847 },
            { name: "Bozeman Yellowstone International Airport", code: "BZN", lat: 45.7769, lon: -111.1530, weather_score: 26.88269709,
                temperature_C_norm: 0.1975801334, dew_point_C_norm: 0.1471781332, humidity_percent_norm: 0.7875939783, precipitation_mm_norm: 0.1518964658,
                wind_direction_deg_norm: 0.3387999697, wind_speed_kmh_norm: 0.003876154585, pressure_hPa_norm: 0.871983975, snow_mm_norm: 0.06013920847 },
            { name: "Charlotte Douglas International Airport", code: "CLT", lat: 35.2144, lon: -80.9473, weather_score: 68.97626164,
                temperature_C_norm: 0.6513472422, dew_point_C_norm: 0.5529135539, humidity_percent_norm: 0.7363163991, precipitation_mm_norm: 0.5143005685,
                wind_direction_deg_norm: 0.4047255172, wind_speed_kmh_norm: 0.1405530197, pressure_hPa_norm: 0.9411534688, snow_mm_norm: 0.003372767623 },
            { name: "Denver International Airport", code: "DEN", lat: 39.8561, lon: -104.6737, weather_score: 35.17751868,
                temperature_C_norm: 0.3293743236, dew_point_C_norm: 0.07979458341, humidity_percent_norm: 0.5092011034, precipitation_mm_norm: 0.1405885807,
                wind_direction_deg_norm: 0.7199762771, wind_speed_kmh_norm: 0.7848527541, pressure_hPa_norm: 0.5063782406, snow_mm_norm: 0.0619873189 },
            { name: "Des Moines International Airport", code: "DSM", lat: 41.5340, lon: -93.6631, weather_score: 65.61579983,
                temperature_C_norm: 0.3275407944, dew_point_C_norm: 0.3236286035, humidity_percent_norm: 0.8527596877, precipitation_mm_norm: 0.643074774,
                wind_direction_deg_norm: 0.6669071791, wind_speed_kmh_norm: 0.5979514791, pressure_hPa_norm: 0.8033153109, snow_mm_norm: 0.1449187723 },
            { name: "Sioux Falls Regional Airport", code: "FSD", lat: 43.5850, lon: -96.7419, weather_score: 52.17586821,
                temperature_C_norm: 0.1651845133, dew_point_C_norm: 0.1973549945, humidity_percent_norm: 0.9310400646, precipitation_mm_norm: 0.507613426,
                wind_direction_deg_norm: 0.4494931166, wind_speed_kmh_norm: 0.56335158, pressure_hPa_norm: 0.7857479608, snow_mm_norm: 0.2510196194 },
            { name: "William P. Hobby Airport", code: "HOU", lat: 29.6454, lon: -95.2789, weather_score: 86.95749326,
                temperature_C_norm: 0.852125673, dew_point_C_norm: 0.8420175203, humidity_percent_norm: 0.8879720693, precipitation_mm_norm: 0.6012830234,
                wind_direction_deg_norm: 0.1782164749, wind_speed_kmh_norm: 0.293063245, pressure_hPa_norm: 0.8568295073, snow_mm_norm: 0.06013920847 },
            { name: "Washington Dulles International Airport", code: "IAD", lat: 38.9531, lon: -77.4565, weather_score: 66.49392517,
                temperature_C_norm: 0.5348115592, dew_point_C_norm: 0.4467752711, humidity_percent_norm: 0.7401809154, precipitation_mm_norm: 0.5561198381,
                wind_direction_deg_norm: 0.6179252953, wind_speed_kmh_norm: 0.2766345273, pressure_hPa_norm: 0.8475299406, snow_mm_norm: 0.03547171006 },
            { name: "George Bush Intercontinental Airport", code: "IAH", lat: 29.9902, lon: -95.3368, weather_score: 85.70588993,
                temperature_C_norm: 0.8093565996, dew_point_C_norm: 0.8220915082, humidity_percent_norm: 0.9349983553, precipitation_mm_norm: 0.6449557962,
                wind_direction_deg_norm: 0.2248161249, wind_speed_kmh_norm: 0.2296314558, pressure_hPa_norm: 0.8283907999, snow_mm_norm: 0.000132482748 },
            { name: "Jackson Hole Airport", code: "JAC", lat: 43.6073, lon: -110.7377, weather_score: 32.68705696,
                temperature_C_norm: 0, dew_point_C_norm: 0, humidity_percent_norm: 0.8879442007, precipitation_mm_norm: 0.4179336427,
                wind_direction_deg_norm: 0, wind_speed_kmh_norm: 0.1669767881, pressure_hPa_norm: 1, snow_mm_norm: 0.06013920847 },
            { name: "John F. Kennedy International Airport", code: "JFK", lat: 40.6413, lon: -73.7781, weather_score: 91.12119922,
                temperature_C_norm: 0.4445126808, dew_point_C_norm: 0.3858127922, humidity_percent_norm: 0.7724937554, precipitation_mm_norm: 1,
                wind_direction_deg_norm: 0.8445983871, wind_speed_kmh_norm: 1, pressure_hPa_norm: 0.8367391926, snow_mm_norm: 0.05466722663 },
            { name: "Harry Reid International Airport", code: "LAS", lat: 36.0840, lon: -115.1537, weather_score: 41.27776312,
                temperature_C_norm: 0.7963985702, dew_point_C_norm: 0.0615248013, humidity_percent_norm: 0, precipitation_mm_norm: 0,
                wind_direction_deg_norm: 0.5873636965, wind_speed_kmh_norm: 0.4107421195, pressure_hPa_norm: 0.3645011805, snow_mm_norm: 0.000017 },
            { name: "Los Angeles International Airport", code: "LAX", lat: 33.9416, lon: -118.4085, weather_score: 46.81943345,
                temperature_C_norm: 0.6376853518, dew_point_C_norm: 0.6119805238, humidity_percent_norm: 0.8592711394, precipitation_mm_norm: 0.1012846856,
                wind_direction_deg_norm: 0.379225694, wind_speed_kmh_norm: 0, pressure_hPa_norm: 0.6650293739, snow_mm_norm: 0.059324316 },
            { name: "LaGuardia Airport", code: "LGA", lat: 40.7769, lon: -73.8740, weather_score: 71.25494783,
                temperature_C_norm: 0.4858392728, dew_point_C_norm: 0.3575552817, humidity_percent_norm: 0.6416939046, precipitation_mm_norm: 0.6179544468,
                wind_direction_deg_norm: 0.7508239269, wind_speed_kmh_norm: 0.861487297, pressure_hPa_norm: 0.800015352, snow_mm_norm: 0.05574208409 },
            { name: "Orlando International Airport", code: "MCO", lat: 28.4312, lon: -81.3081, weather_score: 73.77110232,
                temperature_C_norm: 0.8519241264, dew_point_C_norm: 0.9011904514, humidity_percent_norm: 1, precipitation_mm_norm: 0.3535725964,
                wind_direction_deg_norm: 0.4052791709, wind_speed_kmh_norm: 0.1727226499, pressure_hPa_norm: 0.9224288138, snow_mm_norm: 0 },
            { name: "Miami International Airport", code: "MIA", lat: 25.7617, lon: -80.1918, weather_score: 100,
                temperature_C_norm: 1, dew_point_C_norm: 1, humidity_percent_norm: 0.8829736877, precipitation_mm_norm: 0.6982396055,
                wind_direction_deg_norm: 0.1930775513, wind_speed_kmh_norm: 0.3154000973, pressure_hPa_norm: 0.8813311904, snow_mm_norm: 0.06013920847 },
            { name: "Minneapolis-Saint Paul International Airport", code: "MSP", lat: 44.8848, lon: -93.2223, weather_score: 52.84290439,
                temperature_C_norm: 0.2570642163, dew_point_C_norm: 0.2226275594, humidity_percent_norm: 0.8090226111, precipitation_mm_norm: 0.4175418482,
                wind_direction_deg_norm: 0.6839101832, wind_speed_kmh_norm: 0.5595792621, pressure_hPa_norm: 0.741816632, snow_mm_norm: 0.3452383165 },
            { name: "Will Rogers World Airport", code: "OKC", lat: 35.3931, lon: -97.6008, weather_score: 66.95431289,
                temperature_C_norm: 0.5221369284, dew_point_C_norm: 0.5034552487, humidity_percent_norm: 0.8456775971, precipitation_mm_norm: 0.4801864178,
                wind_direction_deg_norm: 0.5111521357, wind_speed_kmh_norm: 0.8722477651, pressure_hPa_norm: 0.7417658845, snow_mm_norm: 0.02021445618 },
            { name: "Chicago O'Hare International Airport", code: "ORD", lat: 41.9742, lon: -87.9073, weather_score: 58.1344778,
                temperature_C_norm: 0.3581607246, dew_point_C_norm: 0.329399111, humidity_percent_norm: 0.8185654724, precipitation_mm_norm: 0.4758140584,
                wind_direction_deg_norm: 0.7324377218, wind_speed_kmh_norm: 0.6924805052, pressure_hPa_norm: 0.8015076482, snow_mm_norm: 0.0879755242 },
            { name: "Portland International Airport", code: "PDX", lat: 45.5887, lon: -122.5980, weather_score: 55.73653593,
                temperature_C_norm: 0.4117464833, dew_point_C_norm: 0.4222727543, humidity_percent_norm: 0.8980780824, precipitation_mm_norm: 0.4502942036,
                wind_direction_deg_norm: 0.6784869833, wind_speed_kmh_norm: 0.1908851034, pressure_hPa_norm: 0.9438830535, snow_mm_norm: 0.02021405207 },
            { name: "Phoenix Sky Harbor International Airport", code: "PHX", lat: 33.4484, lon: -112.0740, weather_score: 48.928653,
                temperature_C_norm: 0.9172115681, dew_point_C_norm: 0.2928510416, humidity_percent_norm: 0.1101676401, precipitation_mm_norm: 0.04203868598,
                wind_direction_deg_norm: 0.1925863512, wind_speed_kmh_norm: 0.09102867096, pressure_hPa_norm: 0.2890538773, snow_mm_norm: 0.06013920847 },
            { name: "Seattle-Tacoma International Airport", code: "SEA", lat: 47.6062, lon: -122.3321, weather_score: 57.72409636,
                temperature_C_norm: 0.3668809842, dew_point_C_norm: 0.3974512591, humidity_percent_norm: 0.9342446933, precipitation_mm_norm: 0.5136123302,
                wind_direction_deg_norm: 0.3212565661, wind_speed_kmh_norm: 0.3408886015, pressure_hPa_norm: 0.9585089011, snow_mm_norm: 0.00649934652 },
            { name: "San Francisco International Airport", code: "SFO", lat: 37.7749, lon: -122.4194, weather_score: 53.10271312,
                temperature_C_norm: 0.5002152195, dew_point_C_norm: 0.5265026166, humidity_percent_norm: 0.9196826041, precipitation_mm_norm: 0.2295837432,
                wind_direction_deg_norm: 1, wind_speed_kmh_norm: 0.6176962503, pressure_hPa_norm: 0.8214408784, snow_mm_norm: 0.05977429366 },
            { name: "Salt Lake City International Airport", code: "SLC", lat: 40.7899, lon: -111.9791, weather_score: 42.56219095,
                temperature_C_norm: 0.4547642086, dew_point_C_norm: 0.1547463602, humidity_percent_norm: 0.4650742669, precipitation_mm_norm: 0.2085766033,
                wind_direction_deg_norm: 0.6712447303, wind_speed_kmh_norm: 0.4533462446, pressure_hPa_norm: 0.6650305481, snow_mm_norm: 0.05755195553 },
            { name: "St. Louis Lambert International Airport", code: "STL", lat: 38.7477, lon: -90.3600, weather_score: 64.74790429,
                temperature_C_norm: 0.5419142754, dew_point_C_norm: 0.4666550228, humidity_percent_norm: 0.737824213, precipitation_mm_norm: 0.4868848614,
                wind_direction_deg_norm: 0.6369628773, wind_speed_kmh_norm: 0.4704379017, pressure_hPa_norm: 0.8363523462, snow_mm_norm: 0.02411972696 }
        ];

        const map = L.map('map', {
            center: [37.0902, -95.7129],
            zoom: 4,
            attributionControl: false
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: ''
        }).addTo(map);

        map.setView([37.0902, -95.7129], 4);

        function getColor(weather_score) {
            if (weather_score <= 20) return "#00e400";
            if (weather_score <= 40) return "#ffff00";
            if (weather_score <= 60) return "#ff7e00";
            if (weather_score <= 80) return "#ff0000";
            return "#8f3f97";
        }

        function getCircleSize(weather_score) {
            const minSize = 5000;
            const maxSize = 100000;
            return minSize + (maxSize - minSize) * (weather_score / 100);
        }

        function getZoomLevel(circleRadius) {
            const minZoom = 6;
            const maxZoom = 11;
            const minSize = 5000;
            const maxSize = 100000;
            return maxZoom - ((circleRadius - minSize) / (maxSize - minSize)) * (maxZoom - minZoom);
        }

        function getRadiusForParameter(airport, paramKey) {
            if (paramKey === "weather_score") { 
                return getCircleSize(airport.weather_score);
            } else {                
                const standardizeVal = airport[paramKey] || 0;
                return getCircleSize(standardizeVal * 100);
            }
        }

        function updateCirclesForParameter(paramKey) {
            currentParameter = paramKey;
            airports.forEach(airport => {
                const markerData = markers[airport.code];
                if (!markerData) return;

                const newRadius = getRadiusForParameter(airport, paramKey);
                markerData.marker.setRadius(newRadius);
                markerData.size = newRadius;
            });        
        }        

        const airportDropdownButton = document.getElementById('airport-dropdown-button');
        const airportDropdownMenu = document.getElementById('airport-dropdown-menu');
        const parameterDropdownButton = document.getElementById('parameter-dropdown-button');
        const parameterDropdownMenu = document.getElementById('parameter-dropdown-menu');
        const markers = {};

        const parameterOptions = [
            { key: 'weather_score', label: 'Weather Score' },
            { key: 'temperature_C_norm', label: 'Temperature' },
            { key: 'dew_point_C_norm', label: 'Dew Point' },
            { key: 'humidity_percent_norm', label: 'Humidity' },
            { key: 'precipitation_mm_norm', label: 'Precipitation' },
            { key: 'wind_direction_deg_norm', label: 'Wind Direction' },
            { key: 'wind_speed_kmh_norm', label: 'Wind Speed' },
            { key: 'pressure_hPa_norm', label: 'Pressure' },
            { key: 'snow_mm_norm', label: 'Snow' }
        ];

        let currentParameter = 'weather_score';

        airports.forEach(airport => {
            const color = getColor(airport.weather_score);
            const size = getCircleSize(airport.weather_score);

            const marker = L.circle([airport.lat, airport.lon], {
                color: color,
                fillColor: color,
                fillOpacity: 0.7,
                radius: size
            }).addTo(map)
            .bindPopup(L.popup({
                className: 'custom-popup',
                closeButton: false
            }).setContent(
                `<div style='color: white; padding: 5px;'>
                    <div>${airport.name} (${airport.code})</div>
                    <div><strong>Score: ${airport.weather_score.toFixed(2)}</strong></div>
                </div>
            `));

            const popupStyle = document.createElement('style');
            popupStyle.innerHTML = `
                .custom-popup {
                    background: black !important;
                    border: 1px solid black !important;
                    border-radius: 5px !important;
                    color: white !important;
                }
                .custom-popup .leaflet-popup-content-wrapper {
                    background: black !important;
                    border-radius: 5px !important;
                }
                .custom-popup .leaflet-popup-tip {
                    background: black !important;
                }
            `;
            document.head.appendChild(popupStyle);

            markers[airport.code] = { marker: marker, size: size };

            const button = document.createElement('div');
            button.className = 'dropdown-item';
            button.textContent = `${airport.name.replace('International Airport', 'International')} (${airport.code})`;
            button.addEventListener('click', () => {
                const markerData = markers[airport.code];
                if (markerData) {
                    map.closePopup();
                    const zoomLevel = getZoomLevel(markerData.size);
                    map.setView(markerData.marker.getLatLng(), zoomLevel);
                    setTimeout(() => markerData.marker.openPopup(), 100);
                }
                airportDropdownMenu.classList.remove('show');
            });
            airportDropdownMenu.appendChild(button);
        });

        updateCirclesForParameter(currentParameter);

        airportDropdownButton.addEventListener("click", () => {
            airportDropdownMenu.classList.toggle("show");
        });

        parameterDropdownButton.addEventListener('click', () => {
            parameterDropdownMenu.classList.toggle('show');
        });

        parameterOptions.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.textContent = opt.label;
            item.addEventListener('click', () => {
                parameterDropdownButton.textContent = `Radius: ${opt.label}`;
                updateCirclesForParameter(opt.key);
                parameterDropdownMenu.classList.remove('show');
            });
            parameterDropdownMenu.appendChild(item);
        });

        window.addEventListener('click', (event) => {
            if (!event.target.matches('.dropdown-button')) {
                const dropdowns = document.getElementsByClassName("dropdown-menu");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        });

        function updateAirportScore(airportCode, newScore) {
            if (markers[airportCode]) {
                const markerData = markers[airportCode];
                const newColor = getColor(newScore);

                markerData.marker.setStyle({
                    color: newColor,
                    fillColor: newColor
                });
                
                markerData.marker.setPopupContent(
                    `<div style='color: white; padding: 5px;'>
                        <div>${airport.name} (${airport.code})</div>
                        <div><strong>Score: ${newScore.toFixed(2)}</strong></div>
                    </div>
                `);
            }
        }

        const originalView = {
            center: [37.0902, -95.7129],
            zoom: 4
        };

        const resetControl = L.control({ position: 'topleft' });

        resetControl.onAdd = function () {
            const div = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
            div.innerHTML = '<button style="background: #1a1a1a; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; box-shadow: none;">Reset</button>';
            div.onclick = function () {
                map.setView(originalView.center, originalView.zoom);
            };
            return div;
        };

        function adjustMapHeightToKey() {
            const mapEl = document.getElementById('map');
            const keyBar = document.querySelector('.key-bar');
            if (!mapEl || !keyBar) return;
            const mapRect = mapEl.getBoundingClientRect();
            const keyRect = keyBar.getBoundingClientRect();
            const desiredHeight = Math.max(200, Math.round(keyRect.bottom - mapRect.top));
            mapEl.style.height = desiredHeight + 'px';
            if (map && typeof map.invalidateSize === 'function') {
                map.invalidateSize();
            }
        }

        resetControl.addTo(map);

        window.addEventListener('resize', () => {
            setTimeout(adjustMapHeightToKey, 50);
        });
        setTimeout(adjustMapHeightToKey, 100);
    </script>
</body>
</html>
